<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planner ‚Äî Engenharia de Telecomunica√ß√µes</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3e;
    --accent: #6c63ff;
    --accent2: #ff6584;
    --accent3: #43e97b;
    --text: #e8e8f0;
    --text2: #8888aa;
    --text3: #555570;
    --done: #43e97b;
    --blocked: #ff6584;
    --available: #6c63ff;
    --unavailable: #2a2a3e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* BACKGROUND GRID */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(108,99,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(108,99,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  #app { position: relative; z-index: 1; }

  /* HEADER */
  header {
    padding: 28px 40px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0;
    background: rgba(10,10,15,0.92);
    backdrop-filter: blur(12px);
    z-index: 100;
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .logo span { color: var(--text2); }

  .header-stats {
    display: flex; gap: 24px; align-items: center;
  }

  .stat {
    text-align: right;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text2);
  }

  .stat strong {
    display: block;
    font-size: 18px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-weight: 800;
  }

  .progress-bar-wrap {
    width: 160px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* LAYOUT */
  .layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    height: calc(100vh - var(--ui-offset, 113px));
    overflow: hidden;
  }

  /* LEFT PANEL */
  .left-panel {
    padding: 32px 40px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    height: 100%;
  }

  /* LEGEND */
  .legend {
    display: flex; gap: 16px; flex-wrap: wrap;
    margin-bottom: 28px;
  }

  .legend-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .legend-dot {
    width: 8px; height: 8px; border-radius: 50%;
  }

  /* PERIOD SECTION */
  .period-section { margin-bottom: 40px; }

  .period-title {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 12px;
    display: flex; align-items: center; gap: 12px;
  }

  .period-title::after {
    content: '';
    flex: 1; height: 1px;
    background: var(--border);
  }

  .subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 10px;
  }

  /* SUBJECT CARD */
  .subject-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .subject-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--border);
    transition: background 0.2s;
  }

  .subject-card:hover:not(.unavailable):not(.selected) {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(108,99,255,0.15);
  }

  .subject-card:hover:not(.unavailable):not(.selected)::before {
    background: var(--accent);
  }

  .subject-card.available::before { background: var(--accent); }
  .subject-card.done::before { background: var(--done); }
  .subject-card.selected { background: var(--surface2); border-color: var(--accent2); }
  .subject-card.selected::before { background: var(--accent2); }
  .subject-card.unavailable { opacity: 0.35; cursor: not-allowed; }
  .subject-card.unavailable::before { background: var(--text3); }
  .subject-card.time-conflict { border-color: var(--blocked); opacity: 0.5; cursor: not-allowed; }
  .subject-card.time-conflict::before { background: var(--blocked); }

  .card-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 6px;
  }

  .card-name {
    font-weight: 700;
    font-size: 13px;
    line-height: 1.35;
    flex: 1;
    padding-right: 8px;
  }

  .card-code {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--text3);
    white-space: nowrap;
    margin-top: 2px;
  }

  .card-cht {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .card-status-text {
    font-size: 10px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    margin-top: 6px;
  }

  .card-status-text.done-label { color: var(--done); }
  .card-status-text.selected-label { color: var(--accent2); }

  .badge-type {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    padding: 1px 5px;
    border-radius: 3px;
    margin-top: 4px;
    display: inline-block;
  }

  .badge-OB { background: rgba(108,99,255,0.15); color: var(--accent); }
  .badge-E  { background: rgba(255,101,132,0.15); color: var(--accent2); }
  .badge-O  { background: rgba(67,233,123,0.12); color: var(--accent3); }
  .badge-AC { background: rgba(255,200,80,0.12); color: #ffc850; }

  /* ADD BUTTON ON CARD */
  .card-add-btn {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--accent);
    background: rgba(108,99,255,0.15);
    color: var(--accent);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .card-add-btn:hover { background: var(--accent); color: #fff; }
  .card-add-btn.card-add-active {
    border-color: var(--accent2);
    background: rgba(255,101,132,0.12);
    color: var(--accent2);
  }
  .card-add-btn.card-add-active:hover { background: var(--accent2); color: #fff; }

  /* REQ INFO ON CARD */
  .card-req {
    font-size: 10px;
    color: var(--text3);
    margin-top: 6px;
    line-height: 1.6;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
  }
  .req-label {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text3);
    margin-right: 2px;
  }

  /* REQ STATUS TAGS */
  .req-tag {
    display: inline-block;
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    padding: 3px 8px;
    border-radius: 4px;
    line-height: 1.4;
    white-space: nowrap;
    font-weight: 700;
  }
  .req-done {
    background: rgba(67,233,123,0.25);
    color: #2ecc71;
    border: 1px solid rgba(67,233,123,0.5);
  }
  .req-cursando {
    background: rgba(255,200,50,0.2);
    color: #f5c518;
    border: 1px solid rgba(255,200,50,0.5);
  }
  .req-pending {
    background: rgba(255,101,132,0.18);
    color: #ff6b8a;
    border: 1px solid rgba(255,101,132,0.4);
  }

  .req-block {
    font-size: 11px;
    color: var(--text2);
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
  }
  .req-block .req-label {
    display: block;
    width: 100%;
    margin-bottom: 4px;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text3);
  }

  /* RIGHT PANEL */
  .right-panel {
    display: flex; flex-direction: column;
    padding: 32px 24px;
    overflow-y: auto;
    height: 100%;
    gap: 24px;
  }

  /* DETAIL SECTION */
  .detail-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .detail-box h3 {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 14px;
  }

  /* SELECTED SUBJECT DETAILS */
  .detail-name {
    font-size: 16px; font-weight: 800;
    margin-bottom: 4px;
    line-height: 1.3;
  }

  .detail-meta {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-bottom: 14px;
  }

  .detail-chip {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    background: var(--surface2);
    color: var(--text2);
    padding: 3px 8px;
    border-radius: 5px;
  }

  .detail-input-group {
    display: flex; flex-direction: column; gap: 8px;
  }

  .detail-input-group label {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 2px;
  }

  .detail-input-group input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    padding: 9px 12px;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }

  .detail-input-group input:focus { border-color: var(--accent); }

  .day-time-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  }

  /* BUTTONS */
  .btn {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    border: none; cursor: pointer;
    border-radius: 8px;
    padding: 10px 16px;
    transition: all 0.2s;
    width: 100%;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: #7d75ff; }

  .btn-done {
    background: rgba(67,233,123,0.12);
    color: var(--done);
    border: 1px solid rgba(67,233,123,0.25);
  }
  .btn-done:hover { background: rgba(67,233,123,0.2); }

  .btn-done.active {
    background: var(--done);
    color: #0a0a0f;
  }

  .btn-remove {
    background: rgba(255,101,132,0.1);
    color: var(--accent2);
    border: 1px solid rgba(255,101,132,0.2);
  }
  .btn-remove:hover { background: rgba(255,101,132,0.2); }

  .btn-row { display: flex; gap: 8px; }

  /* SCHEDULE TABLE */
  .schedule-table-wrap { overflow-x: auto; }

  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }

  .schedule-table th {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .schedule-table td {
    padding: 10px 10px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }

  .schedule-table tr:last-child td { border-bottom: none; }

  .sched-name { font-weight: 700; font-size: 12px; line-height: 1.3; }
  .sched-detail { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--text3); margin-top: 3px; }

  .sched-day-time {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--accent);
  }

  .empty-state {
    text-align: center;
    padding: 32px 0;
    color: var(--text3);
    font-size: 12px;
    font-family: 'Space Mono', monospace;
  }

  /* PERIOD PLAN TABLE */
  .period-plan {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-top: 0;
  }

  .period-plan h3 {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 14px;
  }

  .period-row { margin-bottom: 14px; }
  .period-row-title {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    text-transform: uppercase;
    margin-bottom: 6px;
    letter-spacing: 0.1em;
  }

  .period-items { display: flex; flex-wrap: wrap; gap: 6px; }

  .period-tag {
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    cursor: default;
  }

  .period-tag.done-tag {
    background: rgba(67,233,123,0.1);
    border-color: rgba(67,233,123,0.3);
    color: var(--done);
  }

  .period-tag.selected-tag {
    background: rgba(108,99,255,0.15);
    border-color: rgba(108,99,255,0.4);
    color: #a09aff;
  }

  /* FILTER BAR */
  .filter-bar {
    display: flex; gap: 8px; flex-wrap: wrap;
    margin-bottom: 20px;
    align-items: center;
  }

  .filter-btn {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    transition: all 0.15s;
  }

  .filter-btn:hover, .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .search-input {
    flex: 1; min-width: 160px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    padding: 6px 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--accent); }

  .placeholder-panel {
    text-align: center;
    padding: 48px 24px;
    color: var(--text3);
  }

  .placeholder-panel .icon { font-size: 40px; margin-bottom: 12px; }
  .placeholder-panel p { font-family: 'Space Mono', monospace; font-size: 11px; line-height: 1.8; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* TOOLTIP */
  .tooltip-wrap { position: relative; }
  .tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%; transform: translateX(-50%);
    background: #1f1f30;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    white-space: nowrap;
    z-index: 50;
    pointer-events: none;
    max-width: 220px;
    white-space: normal;
    text-align: left;
  }
  .tooltip-wrap:hover .tooltip { display: block; }

  /* TABS */
  .tab-bar {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.92);
    backdrop-filter: blur(12px);
    padding: 0 40px;
    position: sticky;
    top: 73px;
    z-index: 99;
  }

  .tab-btn {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 14px 24px;
    border: none;
    background: transparent;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s;
  }

  .tab-btn:hover { color: var(--text2); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* WEEKLY GRID */
  .weekly-wrap {
    padding: 32px 40px;
    overflow-x: auto;
  }

  .weekly-grid {
    border-collapse: collapse;
    width: 100%;
    min-width: 700px;
  }

  .weekly-grid th {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text3);
    padding: 10px 14px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
    background: var(--surface);
  }

  .weekly-grid th:first-child {
    width: 90px;
    text-align: right;
    padding-right: 16px;
    border-right: 2px solid var(--border);
  }

  .weekly-grid td {
    border-right: 1px solid var(--border);
    border-bottom: 1px solid rgba(42,42,62,0.5);
    padding: 0;
    vertical-align: top;
    min-width: 130px;
    height: 44px;
    position: relative;
  }

  .weekly-grid td:first-child {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    text-align: right;
    padding: 0 14px 0 0;
    border-right: 2px solid var(--border);
    white-space: nowrap;
    vertical-align: middle;
    background: var(--surface);
  }

  .weekly-grid tr:last-child td { border-bottom: none; }

  /* WEEKLY GRID CELLS */
  .weekly-grid td.wg-cell {
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: filter 0.15s;
    vertical-align: middle;
    line-height: 1.3;
  }

  .weekly-grid td.wg-cell:hover { filter: brightness(1.3); }

  .weekly-grid td.wg-conflict {
    background: rgba(255,101,132,0.15) !important;
    color: var(--accent2) !important;
    font-size: 11px;
  }

  /* Each color = different subject */
  .color-0 { background: rgba(108,99,255,0.18); color: #b0aaff; border-left: 3px solid #6c63ff; }
  .color-1 { background: rgba(67,233,123,0.15); color: #90f5b8; border-left: 3px solid #43e97b; }
  .color-2 { background: rgba(79,172,254,0.15); color: #9dd5ff; border-left: 3px solid #4facfe; }
  .color-3 { background: rgba(247,151,30,0.15); color: #ffd08a; border-left: 3px solid #f7971e; }
  .color-4 { background: rgba(249,83,198,0.15); color: #ffb3ef; border-left: 3px solid #f953c6; }
  .color-5 { background: rgba(0,210,211,0.15); color: #80f5f5; border-left: 3px solid #00d2d3; }
  .color-6 { background: rgba(255,215,0,0.12); color: #ffe97a; border-left: 3px solid #ffd700; }
  .color-7 { background: rgba(184,242,160,0.12); color: #c2f5a8; border-left: 3px solid #b8f2a0; }
  .color-8 { background: rgba(255,159,243,0.12); color: #ffb3ef; border-left: 3px solid #ff9ff3; }
  .color-9 { background: rgba(255,87,51,0.15); color: #ffb3a0; border-left: 3px solid #ff5733; }

  .weekly-empty {
    text-align: center;
    padding: 80px 0;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    line-height: 2;
  }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; }
    .right-panel { border-top: 1px solid var(--border); }
    header { padding: 16px 20px; }
    .left-panel { padding: 20px; }
    .tab-bar { padding: 0 20px; }
    .weekly-wrap { padding: 20px; }
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">Telecom <span>/ UFF</span> ‚Äî Planner</div>
    <div class="header-stats">
      <div class="stat">
        <strong id="stat-done">0</strong>
        Conclu√≠das
      </div>
      <div class="stat">
        <strong id="stat-selected">0</strong>
        Selecionadas
      </div>
      <div class="stat">
        <strong id="stat-cht">0h</strong>
        CH Total
      </div>
      <div>
        <div class="stat" style="margin-bottom:4px">Progresso do curso</div>
        <div class="progress-bar-wrap">
          <div class="progress-bar" id="progress-bar" style="width:0%"></div>
        </div>
      </div>
    </div>
  </header>

  <nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('planner', this)">üìã Planner</button>
    <button class="tab-btn" onclick="switchTab('quadro', this)">üóì Quadro de Hor√°rios</button>
  </nav>

  <div class="tab-content active" id="tab-planner">
  <div class="layout">
    <div class="left-panel">
      <div class="filter-bar">
        <input class="search-input" type="text" placeholder="Buscar mat√©ria..." id="search-input" oninput="renderAll()">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">Todas</button>
        <button class="filter-btn" data-filter="available" onclick="setFilter('available', this)">Dispon√≠veis</button>
        <button class="filter-btn" data-filter="selected" onclick="setFilter('selected', this)">Selecionadas</button>
        <button class="filter-btn" data-filter="done" onclick="setFilter('done', this)">Conclu√≠das</button>
      </div>
      <div id="subjects-container"></div>
    </div>

    <div class="right-panel">
      <!-- Detail box -->
      <div class="detail-box" id="detail-box">
        <h3>Detalhes</h3>
        <div class="placeholder-panel">
          <div class="icon">üìö</div>
          <p>Selecione uma mat√©ria<br>para ver detalhes e adicionar ao seu plano</p>
        </div>
      </div>

      <!-- Schedule table -->
      <div class="detail-box">
        <h3>Grade de Hor√°rios</h3>
        <div id="schedule-table-container">
          <div class="empty-state">Nenhuma mat√©ria selecionada</div>
        </div>
      </div>

      <!-- Period plan -->
      <div class="period-plan">
        <h3>Plano por Per√≠odo</h3>
        <div id="period-plan-container">
          <div class="empty-state">Selecione mat√©rias para ver o plano</div>
        </div>
      </div>
    </div>
  </div>
  </div><!-- end tab-planner -->

  <div class="tab-content" id="tab-quadro">
    <div class="weekly-wrap">
      <div id="weekly-grid-container">
        <div class="weekly-empty">Nenhuma mat√©ria com hor√°rio definido. Selecione mat√©rias e preencha os hor√°rios no Planner.</div>
      </div>
    </div>
  </div><!-- end tab-quadro -->

</div>

<script>
// ============================================================
// DATA
// ============================================================
const SUBJECTS = [
  // 1¬∫ per√≠odo
  { code:'GMA00154', name:'C√°lculo 1', period:1, cht:60, type:'OB', prereqs:[] },
  { code:'GGE00132', name:'Ecologia Geral', period:1, cht:60, type:'OB', prereqs:[] },
  { code:'GGM00137', name:'Fundamentos de C√°lculo e Geometria', period:1, cht:60, type:'OB', prereqs:[] },
  { code:'TET00317', name:'Introdu√ß√£o √† Engenharia de Telecomunica√ß√µes', period:1, cht:30, type:'OB', prereqs:[] },
  { code:'TCC00326', name:'Programa√ß√£o de Computadores', period:1, cht:60, type:'OB', prereqs:[] },
  { code:'GQI00048', name:'Qu√≠mica Geral Tecnol√≥gica', period:1, cht:75, type:'OB', prereqs:[] },
  // 2¬∫ per√≠odo
  { code:'GMA00155', name:'C√°lculo 2', period:2, cht:60, type:'OB', prereqs:['GGM00137','GMA00154'] },
  { code:'TET00352', name:'Desenho Universal para Aplica√ß√µes Web', period:2, cht:60, type:'OB', prereqs:['TCC00326'] },
  { code:'TCC00319', name:'Estruturas de Dados', period:2, cht:60, type:'OB', prereqs:['TCC00326'] },
  { code:'TDT00076', name:'Fundamentos de Desenho T√©cnico II', period:2, cht:60, type:'OB', prereqs:[] },
  { code:'GFI00161', name:'F√≠sica Experimental I', period:2, cht:30, type:'OB', prereqs:[], coreqs:['GFI00158'] },
  { code:'GFI00158', name:'F√≠sica I', period:2, cht:68, type:'OB', prereqs:['GMA00154'] },
  { code:'GAN00140', name:'√Ålgebra Linear', period:2, cht:60, type:'OB', prereqs:['GGM00137'] },
  // 3¬∫ per√≠odo
  { code:'TET00353', name:'Circuitos Digitais 1', period:3, cht:60, type:'OB', prereqs:[], pch:600 },
  { code:'GMA00156', name:'C√°lculo 3', period:3, cht:60, type:'OB', prereqs:['GAN00140','GMA00155'] },
  { code:'GMA00158', name:'C√°lculo 4', period:3, cht:60, type:'OB', prereqs:['GAN00140','GMA00155'] },
  { code:'GET00177', name:'Estat√≠stica B√°sica', period:3, cht:60, type:'OB', prereqs:['GMA00155'] },
  { code:'GFI00162', name:'F√≠sica Experimental II', period:3, cht:30, type:'OB', prereqs:['GFI00161'], coreqs:['GFI00159'] },
  { code:'GFI00159', name:'F√≠sica II', period:3, cht:68, type:'OB', prereqs:['GFI00158','GMA00155'] },
  { code:'TCC00328', name:'Programa√ß√£o Orientada a Objetos', period:3, cht:68, type:'OB', prereqs:['TCC00319'] },
  { code:'TET00279', name:'Redes Locais e de Acesso', period:3, cht:60, type:'OB', prereqs:['TCC00319'] },
  // 4¬∫ per√≠odo
  { code:'TET00355', name:'Circuitos El√©tricos no Dom√≠nio do Tempo I', period:4, cht:60, type:'OB', prereqs:['GFI00159','GMA00158'] },
  { code:'TET00281', name:'Eletromagnetismo I: Campos Est√°ticos', period:4, cht:60, type:'OB', prereqs:['GFI00159','GMA00156','GMA00158'] },
  { code:'GFI00163', name:'F√≠sica Experimental III', period:4, cht:30, type:'OB', prereqs:['GFI00162'], coreqs:['GFI00160'] },
  { code:'GFI00160', name:'F√≠sica III', period:4, cht:68, type:'OB', prereqs:['GFI00159'] },
  { code:'TET00284', name:'Interconex√£o de Redes I', period:4, cht:60, type:'OB', prereqs:['TET00279'] },
  { code:'TET00282', name:'Modelos Probabil√≠sticos em Engenharia de Telecomunica√ß√µes', period:4, cht:60, type:'OB', prereqs:['GET00177','GMA00158'] },
  { code:'TET00257', name:'M√©todos Matem√°ticos Aplicados √† Engenharia de Telecomunica√ß√µes', period:4, cht:60, type:'OB', prereqs:['GAN00140','GMA00156','GMA00158'] },
  // 5¬∫ per√≠odo
  { code:'TGT00023', name:'Atividade de Extens√£o I', period:5, cht:60, type:'OB', prereqs:[], pch:1000 },
  { code:'TET00354', name:'Circuitos El√©tricos no Dom√≠nio da Frequ√™ncia I', period:5, cht:60, type:'OB', prereqs:['TET00355'] },
  { code:'TET00286', name:'Eletromagnetismo II: Campos Vari√°veis', period:5, cht:60, type:'OB', prereqs:['TET00281'] },
  { code:'GFI00155', name:'F√≠sica Experimental IV', period:5, cht:30, type:'OB', prereqs:['GFI00163'], coreqs:['GFI00171'] },
  { code:'GFI00171', name:'F√≠sica IV', period:5, cht:68, type:'OB', prereqs:['GFI00160'] },
  { code:'TET00285', name:'Interconex√£o de Redes II', period:5, cht:60, type:'OB', prereqs:['TET00284'] },
  { code:'TCC00325', name:'M√©todos Num√©ricos', period:5, cht:60, type:'OB', prereqs:['GMA00155'] },
  { code:'TET00287', name:'Sinais e Sistemas I', period:5, cht:60, type:'OB', prereqs:['TET00257'] },
  { code:'TEC00240', name:'√âtica, Cidadania e Legisla√ß√£o', period:5, cht:30, type:'OB', prereqs:[] },
  // 6¬∫ per√≠odo
  { code:'TGT00024', name:'Atividade de Extens√£o II', period:6, cht:60, type:'OB', prereqs:['TGT00023'] },
  { code:'TET00356', name:'Eletr√¥nica Anal√≥gica 1', period:6, cht:60, type:'OB', prereqs:['TET00354'] },
  { code:'TET00358', name:'Fundamentos de Processamento Digital de Sinais I', period:6, cht:60, type:'OB', prereqs:['TET00353','TET00257'] },
  { code:'TET00295', name:'Laborat√≥rio de Redes', period:6, cht:60, type:'OB', prereqs:['TET00285'] },
  { code:'TET00293', name:'Propaga√ß√£o e Antenas', period:6, cht:60, type:'OB', prereqs:['TET00286'] },
  { code:'TET00292', name:'Propaga√ß√£o em Guias de Onda', period:6, cht:60, type:'OB', prereqs:['TET00286'] },
  { code:'TET00288', name:'Sinais e Sistemas II', period:6, cht:60, type:'OB', prereqs:['TET00282','TET00287'] },
  { code:'TET00296', name:'Telefonia Fixa e Aspectos Regulat√≥rios', period:6, cht:60, type:'OB', prereqs:['TET00257','TET00285'] },
  // 7¬∫ per√≠odo
  { code:'TET00298', name:'Dispositivos Fot√¥nicos', period:7, cht:30, type:'OB', prereqs:['TET00292'] },
  { code:'TET00357', name:'Eletr√¥nica Anal√≥gica 2', period:7, cht:60, type:'OB', prereqs:['TET00356'] },
  { code:'TGT00001', name:'Est√°gio Curricular Obrigat√≥rio', period:7, cht:160, type:'OB', prereqs:[], pch:2300 },
  { code:'TET00301', name:'Fundamentos de Sistemas M√≥veis', period:7, cht:60, type:'OB', prereqs:['TET00286','TET00288'] },
  { code:'TET00300', name:'Sistemas de Radiodifus√£o', period:7, cht:60, type:'OB', prereqs:['TET00288'] },
  { code:'TET00297', name:'Sistemas de Transmiss√£o e Radioenlace', period:7, cht:60, type:'OB', prereqs:['TET00288','TET00293'] },
  { code:'TET00299', name:'Teoria da Informa√ß√£o e C√≥digos', period:7, cht:60, type:'OB', prereqs:['TET00288'] },
  // 8¬∫ per√≠odo
  { code:'TET00305', name:'Arquitetura e Sistemas de Computa√ß√£o para Telecomunica√ß√µes', period:8, cht:60, type:'E', prereqs:['TET00285'], pch:2500 },
  { code:'TET00307', name:'Dispositivos Passivos de Micro-Ondas', period:8, cht:60, type:'E', prereqs:['TET00292'], pch:2500 },
  { code:'TET00350', name:'Projeto de Eletr√¥nica I', period:8, cht:60, type:'OB', prereqs:['TET00356','TET00358'] },
  { code:'TET00349', name:'Projeto de Extens√£o', period:8, cht:60, type:'OB', prereqs:[], pch:2300 },
  { code:'TET00304', name:'Seguran√ßa de Redes', period:8, cht:60, type:'E', prereqs:['TET00285'], pch:2500 },
  { code:'TET00302', name:'Sistema de Comunica√ß√£o via Sat√©lite', period:8, cht:60, type:'OB', prereqs:['TET00288','TET00293'] },
  { code:'TET00306', name:'Sistemas de Comunica√ß√µes √ìticas', period:8, cht:60, type:'E', prereqs:['TET00298'], pch:2500 },
  // 9¬∫ per√≠odo
  { code:'TET00314', name:'Antenas para Altas Frequ√™ncias e Conjuntos', period:9, cht:60, type:'E', prereqs:['TET00293'], pch:2500 },
  { code:'TET00312', name:'Aplica√ß√µes em Redes', period:9, cht:60, type:'E', prereqs:['TCC00328','TET00285'], pch:2500 },
  { code:'TET00311', name:'Ger√™ncia de Redes e Engenharia de Tr√°fego', period:9, cht:60, type:'E', prereqs:['TCC00328','TET00285'], pch:2500 },
  { code:'TET00315', name:'Medi√ß√µes em √ìtica e Radiofrequ√™ncia', period:9, cht:60, type:'E', prereqs:['TET00298','TET00307'], pch:2500 },
  { code:'TET00308', name:'Metodologia Cient√≠fica Aplicada √† Engenharia de Telecomunica√ß√µes', period:9, cht:30, type:'OB', prereqs:[], pch:2800 },
  { code:'TET00351', name:'Projeto de Eletr√¥nica II', period:9, cht:60, type:'OB', prereqs:['TET00357','TET00350'] },
  { code:'TGT00025', name:'Projeto Final de Curso 1', period:9, cht:15, type:'OB', prereqs:[], pch:2800 },
  { code:'TET00313', name:'Redes Multim√≠dia', period:9, cht:60, type:'E', prereqs:['TET00285'], pch:2500 },
  { code:'TET00316', name:'Sistemas de Comunica√ß√µes de √öltima Gera√ß√£o', period:9, cht:60, type:'E', prereqs:['TET00301'], pch:2500 },
  // 10¬∫ per√≠odo
  { code:'TEP00108', name:'Administra√ß√£o Aplicada √† Engenharia', period:10, cht:60, type:'OB', prereqs:[], pch:2700 },
  { code:'TEP00109', name:'Economia Aplicada √† Engenharia', period:10, cht:60, type:'OB', prereqs:[], pch:2700 },
  { code:'TGT00026', name:'Projeto Final de Curso 2', period:10, cht:15, type:'OB', prereqs:['TET00308','TGT00025'], pch:2500 },
  // N√£o periodizadas
  { code:'TET00348', name:'Antenas Lineares', period:null, cht:60, type:'O', prereqs:['TET00286'] },
  { code:'TET00326', name:'Aprendizado de M√°quinas', period:null, cht:60, type:'O', prereqs:['TCC00326','GET00177'] },
  { code:'TGT00027', name:'Atividades Complementares 1', period:null, cht:50, type:'AC', prereqs:[] },
  { code:'TGT00028', name:'Atividades Complementares de Extens√£o', period:null, cht:15, type:'AC', prereqs:[] },
  { code:'TCC00287', name:'Banco de Dados I', period:null, cht:64, type:'O', prereqs:['TCC00326','TCC00319'] },
  { code:'TET00330', name:'Cidades Inteligentes', period:null, cht:60, type:'O', prereqs:['TET00284'] },
  { code:'TET00333', name:'Fot√¥nica Computacional I', period:null, cht:60, type:'O', prereqs:['TET00286','TET00307'] },
  { code:'TET00334', name:'Fundamentos de Comunica√ß√£o √ìptica I', period:null, cht:60, type:'O', prereqs:[] },
  { code:'TET00331', name:'Ger√™ncia e Seguran√ßa de Redes', period:null, cht:60, type:'O', prereqs:['TET00284'] },
  { code:'TET00303', name:'Infraestrutura para Telecomunica√ß√µes', period:null, cht:60, type:'O', prereqs:['GFI00158'] },
  { code:'TET00359', name:'Instrumenta√ß√£o e Sensores para IoT I', period:null, cht:60, type:'O', prereqs:[] },
  { code:'TET00360', name:'Instrumenta√ß√£o e Sensores para IoT II', period:null, cht:60, type:'O', prereqs:['TET00359'] },
  { code:'TET00319', name:'Introdu√ß√£o ao Kit de Desenvolvimento Arduino I', period:null, cht:60, type:'O', prereqs:['TCC00326','TET00355'] },
  { code:'TET00339', name:'Introdu√ß√£o ao Wifi', period:null, cht:60, type:'O', prereqs:[] },
  { code:'TET00011', name:'Introdu√ß√£o √†s Redes Neurais Artificiais', period:null, cht:68, type:'O', prereqs:[] },
  { code:'GLC00292', name:'Libras I', period:null, cht:30, type:'O', prereqs:[] },
  { code:'TET00341', name:'Microondas II', period:null, cht:60, type:'O', prereqs:['TET00307'] },
  { code:'TET00322', name:'Optoeletr√¥nica e Fot√¥nica: Tecnologia de Fibras √ìpticas Polim√©ricas', period:null, cht:68, type:'O', prereqs:['TET00306'] },
  { code:'TET00343', name:'T√≥picos Especiais em Engenharia de Telecomunica√ß√µes I', period:null, cht:60, type:'O', prereqs:['TET00295'] },
  { code:'TET00344', name:'T√≥picos Especiais em Engenharia de Telecomunica√ß√µes II', period:null, cht:60, type:'O', prereqs:['TET00282'] },
  { code:'TET00345', name:'T√≥picos Especiais em Engenharia de Telecomunica√ß√µes III', period:null, cht:60, type:'O', prereqs:[] },
  { code:'TET00346', name:'T√≥picos Especiais: Mobilidade Acad√™mica', period:null, cht:60, type:'O', prereqs:[] },
];

const DAYS_PT = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
const DAYS_SHORT = ['SEG','TER','QUA','QUI','SEX','SAB'];

// ============================================================
// STATE
// ============================================================
let state = loadState();

function loadState() {
  try {
    const s = localStorage.getItem('telecom_planner');
    if (s) return JSON.parse(s);
  } catch(e) {}
  return { done: [], selected: {}, filter: 'all' };
}

function saveState() {
  localStorage.setItem('telecom_planner', JSON.stringify(state));
}

// state.selected = { code: { professor, turma, dias: [{dia, inicio, fim}] } }
// state.done = [code, ...]

let activeCard = null; // currently expanded detail card
let currentFilter = 'all';

// ============================================================
// LOGIC
// ============================================================
function isDone(code) { return state.done.includes(code); }
function isSelected(code) { return !!state.selected[code]; }

function prereqsMet(subject) {
  return subject.prereqs.every(req => isDone(req));
}

function getTotalDoneCHT() {
  return state.done.reduce((acc, code) => {
    const s = SUBJECTS.find(x => x.code === code);
    return acc + (s ? s.cht : 0);
  }, 0);
}

function pchMet(subject) {
  if (!subject.pch) return true;
  return getTotalDoneCHT() >= subject.pch;
}

function getStatus(subject) {
  if (isDone(subject.code)) return 'done';
  if (isSelected(subject.code)) return 'selected';
  if (!prereqsMet(subject) || !pchMet(subject)) return 'unavailable';
  if (hasTimeConflict(subject.code)) return 'time-conflict';
  return 'available';
}

function hasTimeConflict(code) {
  if (!isSelected(code)) return false;
  const info = state.selected[code];
  if (!info || !info.dias || info.dias.length === 0) return false;
  // check conflict with other selected
  for (const [otherCode, otherInfo] of Object.entries(state.selected)) {
    if (otherCode === code) continue;
    if (!otherInfo.dias) continue;
    for (const slot of info.dias) {
      for (const otherSlot of otherInfo.dias) {
        if (slot.dia === otherSlot.dia && timesOverlap(slot.inicio, slot.fim, otherSlot.inicio, otherSlot.fim)) {
          return true;
        }
      }
    }
  }
  return false;
}

function timesOverlap(s1, e1, s2, e2) {
  if (!s1 || !e1 || !s2 || !e2) return false;
  const toMin = t => { const [h,m] = t.split(':').map(Number); return h*60+m; };
  return toMin(s1) < toMin(e2) && toMin(s2) < toMin(e1);
}

function selectSubject(code) {
  // Opens the edit detail panel; if not yet in state, creates a draft
  const subj = SUBJECTS.find(s => s.code === code);
  if (!subj) return;
  const status = getStatus(subj);
  if (status === 'done' || status === 'unavailable') return;
  if (!isSelected(code)) {
    // Create draft - not confirmed yet (confirmed=false means not shown in grid)
    state.selected[code] = { professor: '', turma: '', dias: [{ dia: '', inicio: '', fim: '' }], confirmed: false };
  }
  activeCard = code;
  saveState();
  renderAll();
}

function confirmSubject(code) {
  if (!state.selected[code]) return;
  const dias = state.selected[code].dias || [];
  // Validate: at least one slot with dia + inicio + fim
  const valid = dias.some(d => d.dia && d.inicio && d.fim);
  if (!valid) {
    alert('Preencha pelo menos um dia e hor√°rio de in√≠cio e fim antes de adicionar.');
    return;
  }
  state.selected[code].confirmed = true;
  saveState();
  renderAll();
  // Switch to quadro tab to show result
  const quadroBtn = document.querySelectorAll('.tab-btn')[1];
  switchTab('quadro', quadroBtn);
}

function previewSubject(code) {
  const subj = SUBJECTS.find(s => s.code === code);
  if (!subj) return;
  // If already selected (in plan), open full detail
  if (isSelected(code)) {
    activeCard = code;
    renderAll();
    return;
  }
  // Done or not-yet-added: show preview (with remove option for done)
  activeCard = '__preview__' + code;
  renderSubjects();
  renderDetailBox();
}

function deselectSubject(code) {
  delete state.selected[code];
  if (activeCard === code) activeCard = null;
  saveState();
  renderAll();
}

function toggleDone(code) {
  if (isDone(code)) {
    state.done = state.done.filter(c => c !== code);
  } else {
    state.done.push(code);
    delete state.selected[code];
    if (activeCard === code) activeCard = null;
  }
  saveState();
  renderAll();
}

function updateField(code, field, value) {
  if (!state.selected[code]) return;
  state.selected[code][field] = value;
  saveState();
  renderScheduleTable();
}

function updateDia(code, idx, field, value) {
  if (!state.selected[code]) return;
  if (!state.selected[code].dias) state.selected[code].dias = [];
  if (!state.selected[code].dias[idx]) state.selected[code].dias[idx] = { dia:'', inicio:'', fim:'' };
  state.selected[code].dias[idx][field] = value;
  saveState();
  renderScheduleTable();
}

function addDia(code) {
  if (!state.selected[code]) return;
  state.selected[code].dias.push({ dia:'', inicio:'', fim:'' });
  saveState();
  renderDetailBox();
}

function removeDia(code, idx) {
  if (!state.selected[code]) return;
  state.selected[code].dias.splice(idx, 1);
  saveState();
  renderDetailBox();
}

// ============================================================
// FILTER
// ============================================================
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderSubjects();
}

// ============================================================
// RENDER
// ============================================================
function renderAll() {
  renderSubjects();
  renderDetailBox();
  renderScheduleTable();
  renderPeriodPlan();
  renderStats();
}

function renderStats() {
  const done = state.done.length;
  const sel = Object.keys(state.selected).length;
  const cht = getTotalDoneCHT();
  const total = SUBJECTS.filter(s => s.type !== 'AC').length;
  document.getElementById('stat-done').textContent = done;
  document.getElementById('stat-selected').textContent = sel;
  document.getElementById('stat-cht').textContent = cht + 'h';
  const pct = Math.round((done / total) * 100);
  document.getElementById('progress-bar').style.width = pct + '%';
}

function renderSubjects() {
  const container = document.getElementById('subjects-container');
  const normalize = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const search = normalize(document.getElementById('search-input').value);

  const periods = [...new Set(SUBJECTS.map(s => s.period))].sort((a,b) => {
    if (a === null) return 1;
    if (b === null) return -1;
    return a - b;
  });

  let html = '';

  for (const period of periods) {
    const subjsRaw = SUBJECTS.filter(s => s.period === period);
    let subjs = subjsRaw.filter(s => {
      const st = getStatus(s);
      if (currentFilter === 'available' && st !== 'available') return false;
      if (currentFilter === 'selected' && st !== 'selected') return false;
      if (currentFilter === 'done' && st !== 'done') return false;
      if (search && !normalize(s.name).includes(search) && !s.code.toLowerCase().includes(search)) return false;
      return true;
    });

    if (subjs.length === 0) continue;

    const label = period === null ? 'N√£o Periodizada' : `${period}¬∫ Per√≠odo`;
    html += `<div class="period-section">
      <div class="period-title">${label}</div>
      <div class="subjects-grid">`;

    for (const s of subjs) {
      const status = getStatus(s);
      const info = state.selected[s.code] || {};

      let statusLabel = '';
      if (status === 'done') statusLabel = `<div class="card-status-text done-label">‚úì Conclu√≠da</div>`;
      else if (status === 'selected') {
        const confirmed = state.selected[s.code] && state.selected[s.code].confirmed;
        statusLabel = `<div class="card-status-text selected-label">${confirmed ? 'üìÖ No quadro de hor√°rios' : '‚úè Rascunho (n√£o adicionado)'}</div>`;
      }
      else if (status === 'unavailable') {
        const pchOk = pchMet(s);
        const prereqOk = prereqsMet(s);
        let reason = '';
        if (!prereqOk && !pchOk) reason = 'Pr√©-req. e CH insuficiente';
        else if (!prereqOk) reason = 'Pr√©-req. pendentes';
        else reason = `CH m√≠n: ${s.pch}h (voc√™ tem ${getTotalDoneCHT()}h)`;
        statusLabel = `<div class="card-status-text">${reason}</div>`;
      }
      else if (status === 'time-conflict') statusLabel = `<div class="card-status-text" style="color:var(--blocked)">‚ö† Conflito de hor√°rio</div>`;

      const isActive = activeCard === s.code;

      // Build prereq/coreq info text
      const prereqList = s.prereqs.map(r => {
        const f = SUBJECTS.find(x=>x.code===r);
        const name = f ? f.name : r;
        const done = isDone(r);
        const cursando = isSelected(r) && state.selected[r] && state.selected[r].confirmed;
        const tag = done
          ? `<span class="req-tag req-done">‚úì ${name}</span>`
          : cursando
            ? `<span class="req-tag req-cursando">‚Üí ${name}</span>`
            : `<span class="req-tag req-pending">${name}</span>`;
        return tag;
      });
      const coreqList  = (s.coreqs||[]).map(r => {
        const f = SUBJECTS.find(x=>x.code===r);
        const name = f ? f.name : r;
        const done = isDone(r);
        const cursando = isSelected(r) && state.selected[r] && state.selected[r].confirmed;
        const tag = done
          ? `<span class="req-tag req-done">‚úì ${name}</span>`
          : cursando
            ? `<span class="req-tag req-cursando">‚Üí ${name}</span>`
            : `<span class="req-tag req-pending">${name}</span>`;
        return tag;
      });
      const reqHtml = [
        prereqList.length ? `<div class="card-req"><span class="req-label">Pr√©-req:</span> ${prereqList.join(' ')}</div>` : '',
        coreqList.length  ? `<div class="card-req"><span class="req-label">Co-req:</span> ${coreqList.join(' ')}</div>`   : ''
      ].join('');

      html += `<div class="subject-card ${status} ${isActive ? 'active-card' : ''}"
        onclick="previewSubject('${s.code}')"
        style="${isActive ? 'border-color:var(--accent2); box-shadow: 0 4px 20px rgba(255,101,132,0.2)' : ''}">
        <div class="card-header">
          <div>
            <div class="card-name">${s.name}</div>
            <div class="card-code">${s.code}</div>
          </div>
          <div class="card-cht">${s.cht}h</div>
        </div>
        <span class="badge-type badge-${s.type}">${s.type === 'OB' ? 'Obrigat√≥ria' : s.type === 'E' ? 'Eletiva' : s.type === 'O' ? 'Optativa' : 'Ativ. Compl.'}</span>
        ${reqHtml}
        ${statusLabel}
      </div>`;
    }

    html += `</div></div>`;
  }

  container.innerHTML = html || '<div class="empty-state" style="padding:60px 0">Nenhuma mat√©ria encontrada</div>';
}

function renderDetailBox() {
  const box = document.getElementById('detail-box');

  // Preview mode (card clicked but not yet added)
  if (activeCard && activeCard.startsWith('__preview__')) {
    const code = activeCard.replace('__preview__','');
    const s = SUBJECTS.find(x => x.code === code);
    if (!s) { box.innerHTML = '<h3>Detalhes</h3>'; return; }
    const prereqList = s.prereqs.map(r => {
      const f = SUBJECTS.find(x=>x.code===r);
      const name = f ? f.name : r;
      const done = isDone(r);
      const cursando = isSelected(r) && state.selected[r] && state.selected[r].confirmed;
      return done
        ? `<span class="req-tag req-done">‚úì ${name}</span>`
        : cursando
          ? `<span class="req-tag req-cursando">‚Üí ${name}</span>`
          : `<span class="req-tag req-pending">${name}</span>`;
    });
    const coreqList  = (s.coreqs||[]).map(r => {
      const f = SUBJECTS.find(x=>x.code===r);
      const name = f ? f.name : r;
      const done = isDone(r);
      const cursando = isSelected(r) && state.selected[r] && state.selected[r].confirmed;
      return done
        ? `<span class="req-tag req-done">‚úì ${name}</span>`
        : cursando
          ? `<span class="req-tag req-cursando">‚Üí ${name}</span>`
          : `<span class="req-tag req-pending">${name}</span>`;
    });
    const status = getStatus(s);
    const canAdd = status === 'available';
    box.innerHTML = `
      <h3>Detalhes</h3>
      <div class="detail-name">${s.name}</div>
      <div class="detail-meta">
        <span class="detail-chip">${s.code}</span>
        <span class="detail-chip">${s.cht}h</span>
        <span class="detail-chip">${s.period ? s.period+'¬∫ per√≠odo' : 'N√£o periodizada'}</span>
        <span class="badge-type badge-${s.type}" style="font-size:11px;padding:3px 8px">${s.type==='OB'?'Obrigat√≥ria':s.type==='E'?'Eletiva':s.type==='O'?'Optativa':'Ativ. Compl.'}</span>
      </div>
      ${prereqList.length ? `<div class="req-block"><span class="req-label">Pr√©-requisitos</span>${prereqList.join(' ')}</div>` : ''}
      ${coreqList.length  ? `<div class="req-block"><span class="req-label">Co-requisitos</span>${coreqList.join(' ')}</div>`  : ''}
      ${!prereqList.length && !coreqList.length ? `<div class="req-block" style="color:var(--accent3)">‚úì Sem pr√© ou co-requisitos</div>` : ''}
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px">
        ${canAdd
          ? `<button class="btn btn-primary" onclick="selectSubject('${s.code}')">+ Adicionar ao plano</button>`
          : status==='done'
            ? `<div style="font-family:Space Mono,monospace;font-size:11px;color:var(--done);padding:4px 0">‚úì Conclu√≠da</div>
               <button class="btn btn-remove" onclick="toggleDone('${s.code}')">Remover conclus√£o</button>`
            : `<div style="font-family:Space Mono,monospace;font-size:11px;color:var(--text3);padding:10px 0">${
                status==='unavailable' ? (pchMet(s) ? 'Pr√©-requisitos pendentes' : `CH m√≠nima: ${s.pch}h (voc√™ tem ${getTotalDoneCHT()}h)`)
                : ''
              }</div>`
        }
      </div>`;
    return;
  }

  if (!activeCard || !state.selected[activeCard]) {
    box.innerHTML = `<h3>Detalhes</h3>
      <div class="placeholder-panel">
        <div class="icon">üìö</div>
        <p>Clique em uma mat√©ria para ver detalhes</p>
      </div>`;
    return;
  }

  const s = SUBJECTS.find(x => x.code === activeCard);
  const info = state.selected[activeCard];
  const prereqList2 = s.prereqs.map(r => { const f=SUBJECTS.find(x=>x.code===r); return f?f.name:r; });
  const coreqList2  = (s.coreqs||[]).map(r => { const f=SUBJECTS.find(x=>x.code===r); return f?f.name:r; });
  const prereqNames = prereqList2.join(', ');
  const makeReqTag = r => {
    const f = SUBJECTS.find(x=>x.code===r); const name = f?f.name:r;
    const done = isDone(r); const cursando = isSelected(r) && state.selected[r] && state.selected[r].confirmed;
    return done ? `<span class="req-tag req-done">‚úì ${name}</span>` : cursando ? `<span class="req-tag req-cursando">‚Üí ${name}</span>` : `<span class="req-tag req-pending">${name}</span>`;
  };
  const prereqList2map = s.prereqs.map(makeReqTag).join(' ');
  const coreqList2map  = (s.coreqs||[]).map(makeReqTag).join(' ');

  let diasHtml = '';
  const dias = info.dias || [];
  dias.forEach((slot, idx) => {
    diasHtml += `<div class="day-time-grid" style="margin-bottom:8px; align-items:center">
      <div>
        <label>Dia</label>
        <select style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:Syne,sans-serif;font-size:13px;padding:9px 12px;outline:none;width:100%;transition:border-color 0.2s"
          onchange="updateDia('${s.code}', ${idx}, 'dia', this.value)">
          <option value="" ${!slot.dia?'selected':''}>‚Äî</option>
          ${DAYS_PT.map((d,i) => `<option value="${DAYS_SHORT[i]}" ${slot.dia===DAYS_SHORT[i]?'selected':''}>${d}</option>`).join('')}
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:6px;align-items:end">
        <div>
          <label>In√≠cio</label>
          <input type="time" value="${slot.inicio||''}" onchange="updateDia('${s.code}', ${idx}, 'inicio', this.value)"
            style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:Syne,sans-serif;font-size:13px;padding:9px 8px;outline:none;width:100%">
        </div>
        <div>
          <label>Fim</label>
          <input type="time" value="${slot.fim||''}" onchange="updateDia('${s.code}', ${idx}, 'fim', this.value)"
            style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:Syne,sans-serif;font-size:13px;padding:9px 8px;outline:none;width:100%">
        </div>
        ${dias.length > 1 ? `<button onclick="removeDia('${s.code}', ${idx})" style="background:rgba(255,101,132,0.15);border:none;border-radius:6px;color:var(--accent2);cursor:pointer;padding:8px 10px;font-size:14px;height:38px;align-self:end">‚úï</button>` : ''}
      </div>
    </div>`;
  });

  box.innerHTML = `
    <h3>Detalhes</h3>
    <div class="detail-name">${s.name}</div>
    <div class="detail-meta">
      <span class="detail-chip">${s.code}</span>
      <span class="detail-chip">${s.cht}h</span>
      <span class="detail-chip">${s.period ? s.period+'¬∫ per√≠odo' : 'N√£o periodizada'}</span>
      <span class="badge-type badge-${s.type}" style="font-size:11px;padding:3px 8px">${s.type === 'OB' ? 'Obrigat√≥ria' : s.type === 'E' ? 'Eletiva' : s.type === 'O' ? 'Optativa' : 'Ativ. Compl.'}</span>
    </div>
    ${prereqList2.length ? `<div class="req-block"><span class="req-label">Pr√©-requisitos</span>${prereqList2map}</div>` : ''}
    ${coreqList2.length  ? `<div class="req-block"><span class="req-label">Co-requisitos</span>${coreqList2map}</div>`  : ''}
    <div class="detail-input-group">
      <div>
        <label>Professor</label>
        <input type="text" placeholder="Nome do professor" value="${info.professor||''}"
          oninput="updateField('${s.code}', 'professor', this.value)">
      </div>
      <div>
        <label>Turma</label>
        <input type="text" placeholder="Ex: T01" value="${info.turma||''}"
          oninput="updateField('${s.code}', 'turma', this.value)">
      </div>
      <div>
        <label>Hor√°rios</label>
        ${diasHtml}
        <button class="btn" style="background:var(--surface2);color:var(--text2);border:1px solid var(--border);margin-top:4px;font-size:11px;padding:7px"
          onclick="addDia('${s.code}')">+ Adicionar dia/hor√°rio</button>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px">
      ${!state.selected[s.code].confirmed
        ? `<button class="btn btn-primary" onclick="confirmSubject('${s.code}')">+ Adicionar ao Quadro de Hor√°rios</button>`
        : `<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--accent3);margin-bottom:4px">‚úì No quadro de hor√°rios</div>`
      }
      <div class="btn-row">
        <button class="btn btn-done ${isDone(s.code)?'active':''}" onclick="toggleDone('${s.code}')">
          ${isDone(s.code) ? '‚úì Conclu√≠da' : 'Marcar como conclu√≠da'}
        </button>
        <button class="btn btn-remove" onclick="deselectSubject('${s.code}')">Remover</button>
      </div>
    </div>`;
}

function renderScheduleTable() {
  const container = document.getElementById('schedule-table-container');
  const selected = Object.entries(state.selected).filter(([,info]) => info.confirmed);
  if (selected.length === 0) {
    container.innerHTML = '<div class="empty-state">Nenhuma mat√©ria selecionada</div>';
    return;
  }

  let rows = '';
  for (const [code, info] of selected) {
    const s = SUBJECTS.find(x => x.code === code);
    if (!s) continue;
    const diasStr = (info.dias || []).filter(d => d.dia).map(d => {
      return `${d.dia} ${d.inicio||'?'}‚Äì${d.fim||'?'}`;
    }).join('<br>') || '‚Äî';

    rows += `<tr>
      <td>
        <div class="sched-name">${s.name}</div>
        <div class="sched-detail">${s.code}</div>
      </td>
      <td class="sched-day-time">${diasStr}</td>
      <td style="font-family:Space Mono,monospace;font-size:11px;color:var(--text2)">${info.professor||'‚Äî'}</td>
      <td style="font-family:Space Mono,monospace;font-size:11px;color:var(--text2)">${info.turma||'‚Äî'}</td>
    </tr>`;
  }

  container.innerHTML = `<div class="schedule-table-wrap"><table class="schedule-table">
    <thead><tr>
      <th>Mat√©ria</th><th>Hor√°rios</th><th>Professor</th><th>Turma</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function renderPeriodPlan() {
  const container = document.getElementById('period-plan-container');
  const allPeriods = [...new Set(SUBJECTS.map(s => s.period))].sort((a,b)=>{
    if(a===null) return 1; if(b===null) return -1; return a-b;
  });

  const relevant = allPeriods.filter(p => {
    return SUBJECTS.some(s => s.period === p && (isDone(s.code) || isSelected(s.code)));
  });

  if (relevant.length === 0) {
    container.innerHTML = '<div class="empty-state">Selecione mat√©rias para ver o plano</div>';
    return;
  }

  let html = '';
  for (const p of relevant) {
    const pSubjs = SUBJECTS.filter(s => s.period === p && (isDone(s.code) || isSelected(s.code)));
    const label = p === null ? 'N√£o Periodizada' : `${p}¬∫ Per√≠odo`;
    const tags = pSubjs.map(s => {
      const cls = isDone(s.code) ? 'done-tag' : 'selected-tag';
      return `<span class="period-tag ${cls}">${s.name}</span>`;
    }).join('');
    html += `<div class="period-row">
      <div class="period-row-title">${label}</div>
      <div class="period-items">${tags}</div>
    </div>`;
  }
  container.innerHTML = html;
}

// ============================================================
// TABS
// ============================================================
function switchTab(tab, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  btn.classList.add('active');
  if (tab === 'quadro') renderWeeklyGrid();
}

// ============================================================
// WEEKLY GRID
// ============================================================
function toMinutes(t) {
  if (!t) return null;
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function renderWeeklyGrid() {
  const container = document.getElementById('weekly-grid-container');

  const DAYS_ORDER = ['SEG','TER','QUA','QUI','SEX','SAB'];
  const DAY_LABELS  = { SEG:'Segunda', TER:'Ter√ßa', QUA:'Quarta', QUI:'Quinta', SEX:'Sexta', SAB:'S√°bado' };

  // Collect every slot with full info
  const allSlots = [];
  const colorMap = {};
  let colorIdx = 0;

  for (const [code, info] of Object.entries(state.selected)) {
    if (!info.confirmed) continue; // only show confirmed subjects in grid
    const s = SUBJECTS.find(x => x.code === code);
    if (!s || !info.dias) continue;
    if (!(code in colorMap)) { colorMap[code] = colorIdx++ % 10; }
    for (const slot of info.dias) {
      if (!slot.dia || !slot.inicio || !slot.fim) continue;
      allSlots.push({
        code, name: s.name,
        turma: info.turma || '',
        professor: info.professor || '',
        dia: slot.dia,
        inicio: slot.inicio,
        fim: slot.fim,
        color: colorMap[code]
      });
    }
  }

  // Fixed days: Monday to Friday
  const activeDays = ['SEG','TER','QUA','QUI','SEX'];

  // Fixed hours: 07:00 to 22:00
  const rows = [];
  for (let h = 7; h < 22; h++) {
    const label = `${String(h).padStart(2,'0')}:00 - ${String(h+1).padStart(2,'0')}:00`;
    rows.push({ h, label });
  }

  // For each (day, hour) build what occupies that cell
  // A subject occupies hour h if its start <= h:00 and its end > h:00
  // More precisely: inicio_hour <= h AND fim > h:00 (i.e. fim_hour > h OR (fim_hour == h && fim_min > 0))
  function occupies(slot, h) {
    const [sh] = slot.inicio.split(':').map(Number);
    const [eh, em] = slot.fim.split(':').map(Number);
    const startH = sh;
    // slot occupies hour block h if startH <= h && (eh > h || (eh == h && em > 0))
    // but we want start of block = h, so startH <= h means it starts at or before this hour
    // end > h:00 means eh > h or (eh == h && em > 0)
    return startH <= h && (eh > h || (eh === h && em > 0));
  }

  // Build table
  let html = `<table class="weekly-grid">
    <thead><tr>
      <th>Hor√°rio</th>
      ${activeDays.map(d => `<th>${DAY_LABELS[d]}</th>`).join('')}
    </tr></thead>
    <tbody>`;

  for (const row of rows) {
    html += `<tr><td>${row.label}</td>`;
    for (const day of activeDays) {
      const matches = allSlots.filter(sl => sl.dia === day && occupies(sl, row.h));
      if (matches.length === 0) {
        html += `<td></td>`;
      } else if (matches.length === 1) {
        const m = matches[0];
        const label = m.turma ? `${m.name} (${m.turma})` : m.name;
        html += `<td class="wg-cell color-${m.color}" onclick="goToSubject('${m.code}')" title="${m.name}${m.professor?' ‚Äî '+m.professor:''}">
          ${label}
        </td>`;
      } else {
        // conflict
        const label = matches.map(m => m.name + (m.turma?` (${m.turma})`:'') ).join(' / ');
        html += `<td class="wg-cell wg-conflict" title="Conflito!">‚ö† ${label}</td>`;
      }
    }
    html += `</tr>`;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;
}

function goToSubject(code) {
  // Switch to planner tab and highlight card
  const plannerBtn = document.querySelector('.tab-btn');
  switchTab('planner', plannerBtn);
  activeCard = code;
  renderAll();
  setTimeout(() => {
    const el = document.querySelector(`.subject-card[onclick*="${code}"]`);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ============================================================
// LEGEND
// ============================================================
function injectLegend() {
  const lb = document.querySelector('.left-panel');
  const legend = document.createElement('div');
  legend.className = 'legend';
  legend.innerHTML = `
    <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>Dispon√≠vel</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--accent2)"></div>No plano</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--done)"></div>Conclu√≠da</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--text3)"></div>Bloqueada</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--blocked)"></div>Conflito</div>
  `;
  lb.insertBefore(legend, lb.children[1]);
}

// ============================================================
// INIT
// ============================================================
injectLegend();
renderAll();

// Compute actual header + tabbar height for sticky layout
function fixLayoutHeight() {
  const header = document.querySelector('header');
  const tabbar = document.querySelector('.tab-bar');
  if (header && tabbar) {
    const h = header.offsetHeight + tabbar.offsetHeight;
    document.documentElement.style.setProperty('--ui-offset', h + 'px');
  }
}
fixLayoutHeight();
window.addEventListener('resize', fixLayoutHeight);
</script>
</body>
</html>
